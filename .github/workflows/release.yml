# å½“æ¨é€ tag æ—¶è‡ªåŠ¨åˆ›å»º GitHub Release
# ä½¿ç”¨æ–¹æ³•ï¼šgit tag v1.0.0 && git push origin v1.0.0

name: Create Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥ v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0.0, v2.1.3

jobs:
  release:
    runs-on: windows-latest

    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

    env:
      Project_Path: DC.iCloudPhoto.Sync/DC.iCloudPhoto.Sync.csproj
      App_Name: DC.iCloudPhoto.Sync

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # è·å– tag åç§°
    - name: Get version from tag
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "ç‰ˆæœ¬: $version"
      shell: pwsh

    # å®‰è£… .NET
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # æ¢å¤ä¾èµ–
    - name: Restore dependencies
      run: dotnet restore $env:Project_Path

    # æ„å»º Release ç‰ˆæœ¬
    - name: Build Release
      run: dotnet build $env:Project_Path --configuration Release --no-restore

    # å‘å¸ƒåº”ç”¨ç¨‹åº
    - name: Publish
      run: dotnet publish $env:Project_Path --configuration Release --output ./publish --no-build

    # åˆ›å»º ZIP å‹ç¼©åŒ…
    - name: Create ZIP archive
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipName = "$env:App_Name-$version-win-x64.zip"
        Compress-Archive -Path ./publish/* -DestinationPath ./$zipName
        echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        echo "å·²åˆ›å»º: $zipName"
      id: create_zip
      shell: pwsh

    # åˆ›å»º GitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ“¦ ${{ env.App_Name }} ${{ steps.get_version.outputs.version }}

          ### ä¸‹è½½å’Œä½¿ç”¨

          1. ä¸‹è½½ä¸‹æ–¹çš„ `${{ steps.create_zip.outputs.zip_name }}` æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `DC.iCloudPhoto.Sync.exe`

          ### ä¸»è¦åŠŸèƒ½

          - iCloud ç…§ç‰‡åŒæ­¥å·¥å…·
          - æ”¯æŒ JPG/MP4/MOV æ–‡ä»¶ç±»å‹
          - æ™ºèƒ½æ–‡ä»¶æ¯”å¯¹å’ŒåŒæ­¥
          - è¯¦ç»†çš„æ—¥å¿—è®°å½•

          ### ç³»ç»Ÿè¦æ±‚

          - Windows 10/11
          - .NET 8.0 Runtimeï¼ˆé€šå¸¸å·²å†…ç½®ï¼‰

          ---

          **å®Œæ•´æ›´æ–°æ—¥å¿—**ï¼šè¯·æŸ¥çœ‹æäº¤è®°å½•
        files: |
          ${{ steps.create_zip.outputs.zip_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
